---
title: "Air Pollution over the US"
date: "12/2020"
---


# Results


## Packages
All packages we have used in this section. 
```{r}
library(dplyr)
library(tidyverse)
library(dygraphs)
library(xts)
library(cowplot)
```
## Data
Before moving on, let us draw some insights from each pollutant concentration over the past ten years. 
```{r}
data = read.csv(file='./data/processedData.csv')
data <- data %>% na.omit()
data <- data %>% rename(NO3=TOTAL_NO3, SO2=TOTAL_SO2)
data$date = as.Date(data$date_off)
data$year <- format(as.Date(data$date, "%F"), "%Y")
data$month <- format(as.Date(data$date, "%F"), "%m")
data %>% select(SO2, NO3) %>% summary()
```
* Notes:
  + The mean and the median for each pollutant, especially SO2 is far apart. It implies that median might be a better representation to each pollutant distribution. 
  + The largest observation of each pollutant is hugely deviated from mean and median. We need to visualize the distribution of each pollutant more carefully to eliminate any possible outliers. That is what we will do in the next section. 


### Data Distribution
* In order to visualize the distribution of each pollutant, we constructed boxplots. Moreover, since environmental factors vary across the entire nation, we faceted each boxplot by regions (east, middle, west) to see how the concentration of each pollutant varies by regions. For further information about how we split the regions, please refer to previous section called Data Cleaning. 
* Since most data values are lower than 1, we transform all concentration values with log scale to better visualize them. 
```{r}
selected_cols <- c("date", "REGION","STATE", "COUNTY","VALID_HOURS","SO2", "NO3")
new_data <- data %>% select(selected_cols)

tidy_data <- pivot_longer(new_data, 
             cols=c("SO2", "NO3"),
             names_to = "Pollutant",
             values_to = "Concentration",
             values_drop_na = TRUE)

pollutants <- c("SO2", "NO3")

ggplot(tidy_data, aes(x=reorder(Pollutant, -Concentration, median),
                 y = Concentration)) +
  geom_boxplot(fill="#48C9B0", color = "#117864") +
  coord_flip() + 
  scale_y_log10() +
  facet_grid(rows=vars(REGION))+
  xlab("Pollutant") +
  ylab("Concentration") +
  ggtitle("The Distribution of each Air Pollutant faceted by Regions (SO2, NO3)")
```

* Remarks:
  + For both pollutants, the median value is higher in eastern area than the other two regions. In particular, large numbers of high values emerge in that region. Further investigation is needed.
  + There are lots of outliers in each pollutant data. This observation suggests that we should not delete these outliers since they become a commonplace in this analysis. 
  
## How does air pollution spread over the past ten years?

### Time Series of SO2 and NO3 Across the Nation
* Here we plot two dygraphs, one for each pollutant, to visualize the overall distribution in the past ten years. Feel free to play with them and draw some insights. 
```{r}
time_series_obj <- xts(x = data$SO2, order.by = data$date)
dygraph(time_series_obj,
        main = "Sulfur Dioxide Trend in US",
        xlab = "Date",
        ylab = "SO2 (ug/m^3)") %>% 
  dyRangeSelector()
```

```{r}
time_series_obj <- xts(x = data$NO3, order.by = data$date)
dygraph(time_series_obj,
        main = "Nitrate Trend in US",
        xlab = "Date",
        ylab = "NO3 (ug/m^3)") %>% 
  dyRangeSelector()
```

* The overall trends of SO2 and NO3 are similar as they both peak in January 2011 and February 2014. The only different is that the overall trend of SO2 concentration decreases from year to year, while the trend of NO3 remains unchanged. The Environmental Projection Agency and other related organizations have make lots of effort in regulating the emission of SO2 and many common pollutants such as NO2, PM25 since 1970. However, the air pollution problem remains challenging as there are a lot other toxic pollutants such as NO3. Of course, you may complain the time series above are too dense to analyze. In the next section, we will aggregate the concentration of SO2 and NO3 by month to oberve any secular and cyclical trend over time. 

### Monthly Time Series
* Here, we average SO2 and NO3 by months and get the following two monthly plots. 
```{r}
data_month <- data %>% 
  mutate(month_year = paste(year, month, '01', sep='-')) %>% 
  group_by(month_year) %>% 
  summarise(aver_SO2 = mean(SO2), aver_NO3 = mean(NO3)) %>% 
  ungroup()

plot_SO2 <- ggplot(data_month, aes(x=as.Date(month_year, format="%F"), y=aver_SO2)) +
  geom_line(color='#117864') +
  scale_x_date(breaks = seq(as.Date("2010-01-01"), as.Date("2020-08-01"), by="12 months"), date_labels="%Y") +
  xlab("Date") + 
  ylab("SO2 (ug/m^3)") +
  ggtitle("Monthly Average Sulfer Dioxide Concentration")

plot_NO3 <- ggplot(data_month, aes(x=as.Date(month_year, format="%F"), y=aver_NO3)) +
  geom_line(color='#117864') +
  scale_x_date(breaks = seq(as.Date("2010-01-01"), as.Date("2020-08-01"), by="12 months"), date_labels="%Y") +
  xlab("Date") + 
  ylab("NO3 (ug/m^3)") +
  ggtitle("Monthly Average Nitrate Concentration")

plot_grid(plot_SO2, plot_NO3, nrow = 2)
```

* Remarks:
  + Based on the monthly plots above, we may conclude that the overall SO2 concentration decreases year to year. In particular, it decreases significantly in 2020. We suspect part of the reason might be due to Covid-19. In the next section, we will briefly investigate possible effects of Covid-19 on SO2 emission level.  
  + On the other hand, the overall NO3 concentration slightly diminished from 2010 to 2014 and then remain high since then. In addition to common pollutants like SO2, there are actually lots of toxic pollutants similar to NO3 that are challenging our environment. 
  + We can observe cyclic pattern in both plots above. Then the next question we ask is what is causing the cyclical pattern? A rational guess we have is monthly effect. Therefore, we plot monthly sub-series of a time series for each pollutant as follows. 
  
```{r}
data_month$month_year = as.Date(data_month$month_year)
SO2 <- ts(data_month$aver_SO2, start=c(2010, 1), end=c(2020, 8), frequency = 12)
month_SO2 <- monthplot(SO2, main="Sulfer Dioxide Trend, grouped by month")
```

```{r}
NO3 <- ts(data_month$aver_NO3, start=c(2010, 1), end=c(2020, 8), frequency = 12)
month_NO3 <- monthplot(NO3, main="Nitrate Trend, grouped by month")
```

* Based on the two plots above, we observe that monthly (for seasonal) effect causes the cyclical pattern of SO2 since after we facet the plot by month, the overall trends are similar. And the secular trend of SO2 peak in January and February, which makes sense since winter season requires heaters. 
* On the other hand, monthly effect does not entirely cause the cyclical pattern of NO3 as observed above since the overall trends are still different. 

### Did Covid-19 lockdown significantly reduce air pollution in New York State?
* In India and China, researchers found out that air quality improves significantly in urban districts during lockdown. If you want to dive deeper into this research, please refer to [Comparative study on air quality status in India and Chinese cities before and during the COVID-19 lockdown period](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7375877/){target="_blank"}. By the same interest, we did a brief investigations on the impact of COVID-19 lockdown to the two pollutants, SO2 and NO3. 

* It is unrealistic to investigate the impact of Covid-19 to air pollution across the entire nation since each state responsed differently to the pandemic. Therefore, we decided to choose New York State as a representative. 
The New York State government began with a full lockdown from March 2020 to April 2020 in response to Covid-19 Pandemic. In the following plot, we created a monthly concentration plot by year for each pollutant. Notice in March and April, the SO2 and NO3 concentration level did diminish but not significantly. Therefore, we may conclude that in terms of SO2 and NO3, Covid-19 lockdown did not reduce air pollution significantly. Further investigation is needed on other pollutants. 

```{r}
new_data <- data %>% 
  filter(data$STATE=='NY') %>%
  mutate(month_year = paste(year, month, '01', sep='-')) %>% 
  group_by(month_year) %>% 
  summarise(aver_SO2 = mean(SO2), aver_NO3 = mean(NO3)) %>% 
  ungroup() %>% 
  mutate(
    date = as.Date(month_year),
    xaxis_year = update(date, year = 1),
    year = format(as.Date(date, format="%F"), "%Y")
  )

  ggplot(new_data, aes(xaxis_year, SO2, color = year)) +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    geom_line() +
    xlab("month") +
    ylab("SO2 (ug/m^3)") +
    ggtitle("Monthly SO2 in New York State across each year")
```
```{r}
ggplot(new_data, aes(xaxis_year, NO3, color = year)) +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    geom_line() +
    xlab("month") +
    ylab("NO3 (ug/m^3)") +
    ggtitle("Monthly NO3 in New York State across each year")
```

```{r}
#group by state, calculate mean SO2, mean NO3over past 10 years
dataState<- data%>%group_by(STATE)%>%summarise(SO2 = mean(SO2), NO3=mean(NO3))

library(tools)
library(micromap)
data("USstates")
statePolys <- create_map_table(USstates, IDcolumn = "ST")

lmplot(stat.data = dataState,
       map.data = statePolys,
       panel.types = c('dot_legend', 'labels', 'dot', 'map'),
       panel.data = list(NA, 'STATE','SO2', NA),
       ord.by = 'SO2', 
       rev.ord = TRUE,
       grouping = 5,
       colors = brewer.pal(5, "Set1"),
       median.row = TRUE,
       map.link = c('STATE', 'ID'),
       map.color2 = "white",
       panel.att = list(
         list(1, point.type=20,
              point.border=TRUE),
          list(2, header = "STATE",
               panel.width = 0.2,
               panel.header.face = "bold",
               panel.header.size = 1.2,
               graph.grid.color = "grey99",
               align = "left"),
          list(3, header = "Mean SO2 Pollution Amount", 
               panel.header.face = "bold",
               panel.header.size = 1.2,
               xaxis.title = 'ug/m^3'),
          list(4, header = 'Geographical Location',
               panel.header.face = "bold",
               panel.header.size = 1.2)
          ))
```



```{r}
library(tools)
library(micromap)
data("USstates")
statePolys <- create_map_table(USstates, IDcolumn = "ST")

lmplot(stat.data = dataState,
       map.data = statePolys,
       panel.types = c('dot_legend', 'labels', 'dot', 'map'),
       panel.data = list(NA, 'STATE','NO3', NA),
       ord.by = 'NO3', 
       rev.ord = TRUE,
       grouping = 5,
       colors = brewer.pal(5, "Set1"),
       median.row = TRUE,
       map.link = c('STATE', 'ID'),
       map.color2 = "white",
       panel.att = list(
         list(1, point.type=20,
              point.border=TRUE),
          list(2, header = "STATE",
               panel.width = 0.2,
               panel.header.face = "bold",
               panel.header.size = 1.2,
               graph.grid.color = "grey99",
               align = "left"),
          list(3, header = "Mean NO3 Pollution Amount", 
               panel.header.face = "bold",
               panel.header.size = 1.2,
               xaxis.title = 'ug/m^3'),
          list(4, header = 'Geographical Location',
               panel.header.face = "bold",
               panel.header.size = 1.2)
          ))
```

```{r}
library(choroplethr)
dataState<- data%>%group_by(STATE)%>%summarise(SO2 = mean(SO2), NO3=mean(NO3))

#mean so2 by state
dataStateSO2<-dataState%>%select(STATE,SO2)
dataStateSO2<-dataStateSO2%>%rename(region=STATE, value=SO2)
dataStateSO2$region<-tolower(state.name[match(dataStateSO2$region, state.abb)])

state_choropleth(dataStateSO2,title="Mean SO2 Amount Over 10 Years by State", legend="SO2 Amount by state")+ scale_fill_brewer(palette=8)
```

```{r}
#mean NO3 by state
dataStateNO3<-dataState%>%select(STATE,NO3)
dataStateNO3<-dataStateNO3%>%rename(region=STATE, value=NO3)
dataStateNO3$region<-tolower(state.name[match(dataStateNO3$region, state.abb)])

state_choropleth(dataStateNO3,title="Mean NO3 Amount Over 10 Years by State", legend="NO3 Amount by state")+ scale_fill_brewer(palette=8)
```



```{r}
dataMosaic <- gather(dataState,key = 'pollutant',value = concentration, -STATE)
ggplot(data = dataMosaic, aes(x = reorder(STATE, -concentration), y = concentration, fill = pollutant,order = pollutant)) + 
    geom_bar(stat = "identity") + 
    coord_flip() + 
    ggtitle("Pollutant distribution by states")
```


